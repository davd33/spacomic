;;;; spacomic.lisp

(in-package #:spacomic)

(defvar *win* nil)

(defvar *debug-mode* t)

;; UTILITIES
(defun make-keyword (name)
  (read-from-string (reverse (concatenate 'string
                                          (reverse name) ":"))))

(defun str->kw (string)
  (loop for c across string
        collect (make-keyword (string c))))

(defun char->kw (char)
  (make-keyword (string char)))

;; LETTERS
(defmethod make-letter ((segments list))
  "Takes a list of segments and return a function that,
   when given a rectangle, draws itself on the window.
   A rectangle is a 3 elements list: a start-point, a width and a height."
  (lambda (rect)
    ;; a rectangle has a start-point, a width and a height
    (destructuring-bind ((ry0 rx0) rw rh) rect
      (draw-letter (loop for seg in segments
                         collect (destructuring-bind ((ya xa) (yb xb)) seg
                                   ;; Building a segment: a list of two points.
                                   (let ((YA (round (+ ry0 (* rh ya))))
                                         (XA (round (+ rx0 (* rw xa))))
                                         (YB (round (+ ry0 (* rh yb))))
                                         (XB (round (+ rx0 (* rw xb)))))
                                     `((,YA ,XA)
                                       (,YB ,XB)))))))))

(defparameter letters
  `(:a ,(make-letter '(((1 0) (0 1/2))
                       ((1/2 1/4) (1/2 3/4))
                       ((0 1/2) (1 1))))
    :b ,(make-letter '(((1 1/5) (0 1/5))
                       ((0 1/5) (0 4/5))
                       ((0 4/5) (1/5 1))
                       ((1/5 1) (2/5 1))
                       ((2/5 1) (5/10 4/5))
                       ((5/10 4/5) (3/5 1))
                       ((3/5 1) (4/5 1))
                       ((4/5 1) (1 4/5))
                       ((1 4/5) (1 1/5))))
    :c ,(make-letter '(((1/5 9/10) (0 7/10))
                       ((0 7/10) (0 3/10))
                       ((0 3/10) (2/10 1/10))
                       ((2/10 1/10) (4/5 1/10))
                       ((4/5 1/10) (1 1/5))
                       ((1 1/5) (1 7/10))
                       ((1 7/10) (4/5 9/10))
                       ((4/5 9/10) (7/10 9/10))))
    :d ,(make-letter '(((0 7/10) (0 1/5))
                       ((0 1/5) (1 1/5))
                       ((1 1/5) (1 7/10))
                       ((1 7/10) (4/5 9/10))
                       ((4/5 9/10) (1/5 9/10))
                       ((1/5 9/10) (0 7/10))))
    :e ,(make-letter '(((0 4/5) (0 1/5))
                       ((0 1/5) (1 1/5))
                       ((1 1/5) (1 4/5))
                       ((3/5 1/5) (3/5 3/5))))
    :f ,(make-letter '(((0 9/10) (0 1/5))
                       ((0 1/5) (1 1/5))
                       ((2/5 1/5) (2/5 3/5))))
    :g ,(make-letter '(((1/5 4/5) (1/10 4/5))
                       ((1/10 4/5) (0 7/10))
                       ((0 7/10) (0 1/5))
                       ((0 1/5) (1/10 1/10))
                       ((1/10 1/10) (9/10 1/10))
                       ((9/10 1/10) (1 1/5))
                       ((1 1/5) (1 7/10))
                       ((1 7/10) (9/10 4/5))
                       ((9/10 4/5) (3/5 4/5))
                       ((3/5 4/5) (3/5 5/10))))
    :h ,(make-letter '(((0 1/5) (1 1/5))
                       ((0 4/5) (1 4/5))
                       ((5/10 1/5) (5/10 4/5))))
    :i ,(make-letter '(((0 9/10) (0 1/10))
                       ((1 9/10) (1 1/10))
                       ((0 5/10) (1 5/10))))
    :j ,(make-letter '(((1 1/5) (1 3/5))
                       ((1 3/5) (4/5 4/5))
                       ((4/5 4/5) (0 4/5))
                       ((0 9/10) (0 3/10))))
    :k ,(make-letter '(((0 1/5) (1 1/5))
                       ((5/10 1/5) (0 4/5))
                       ((5/10 1/5) (1 4/5))))
    :l ,(make-letter '(((0 1/5) (1 1/5))
                       ((1 1/5) (1 4/5))))
    :m ,(make-letter '(((1 1/10) (0 1/10))
                       ((0 1/10) (2/5 5/10))
                       ((2/5 5/10) (0 9/10))
                       ((0 9/10) (1 9/10))))
    :n ,(make-letter '(((1 1/10) (0 1/10))
                       ((0 1/10) (1 4/5))
                       ((0 9/10) (1 9/10))))
    :o ,(make-letter '(((1/5 9/10) (0 7/10))
                       ((0 7/10) (0 3/10))
                       ((0 3/10) (1/5 1/10))
                       ((1/5 1/10) (4/5 1/10))
                       ((4/5 1/10) (1 3/10))
                       ((1 3/10) (1 7/10))
                       ((1 7/10) (4/5 9/10))
                       ((4/5 9/10) (1/5 9/10))))
    :p ,(make-letter '(((1 1/5) (0 1/5))
                       ((0 1/5) (0 7/10))
                       ((0 7/10) (1/5 9/10))
                       ((1/5 9/10) (2/5 9/10))
                       ((2/5 9/10) (3/5 7/10))
                       ((3/5 7/10) (3/5 1/5))))
    :q ,(make-letter '(((1/5 9/10) (0 7/10))
                       ((0 7/10) (0 3/10))
                       ((0 3/10) (1/5 1/10))
                       ((1/5 1/10) (4/5 1/10))
                       ((4/5 1/10) (1 3/10))
                       ((1 3/10) (1 7/10))
                       ((1 7/10) (4/5 9/10))
                       ((4/5 9/10) (1/5 9/10))
                       ((1 9/10) (3/5 5/10))))
    :r ,(make-letter '(((1 3/10) (0 3/10))
                       ((0 3/10) (0 7/10))
                       ((0 7/10) (1/5 9/10))
                       ((1/5 9/10) (2/5 9/10))
                       ((2/5 9/10) (3/5 7/10))
                       ((3/5 7/10) (3/5 5/10))
                       ((3/5 5/10) (1 9/10))))
    :s ,(make-letter '(((1 1/5) (1 7/10))
                       ((1 7/10) (4/5 9/10))
                       ((4/5 9/10) (3/5 9/10))
                       ((3/5 9/10) (5/10 7/10))
                       ((5/10 7/10) (5/10 3/10))
                       ((5/10 3/10) (2/5 1/10))
                       ((2/5 1/10) (1/5 1/10))
                       ((1/5 1/10) (0 3/10))
                       ((0 3/10) (0 7/10))
                       ((0 7/10) (1/5 9/10))))
    :t ,(make-letter '(((0 1/10) (0 9/10))
                       ((1 5/10) (0 5/10))))
    :u ,(make-letter '(((0 1/10) (4/5 1/10))
                       ((4/5 1/10) (1 3/10))
                       ((1 3/10) (1 7/10))
                       ((1 7/10) (4/5 9/10))
                       ((4/5 9/10) (0 9/10))))
    :v ,(make-letter '(((0 0) (1 5/10))
                       ((1 5/10) (0 1))))
    :w ,(make-letter '(((0 0) (1 3/10))
                       ((1 3/10) (2/5 5/10))
                       ((2/5 5/10) (1 7/10))
                       ((1 7/10) (0 1))))
    :x ,(make-letter '(((0 1/10) (1 9/10))
                       ((1 1/10) (0 9/10))))
    :y ,(make-letter '(((0 1/10) (5/10 5/10))
                       ((0 9/10) (1 1/5))))
    :z ,(make-letter '(((0 1/10) (0 9/10))
                       ((0 9/10) (1 1/10))
                       ((1 1/10) (1 9/10))))
    :0 ,(make-letter '(((0 1/5) (0 4/5))
                       ((0 4/5) (1 4/5))
                       ((1 4/5) (1 1/5))
                       ((1 1/5) (0 1/5))
                       ((1 1/5) (0 4/5))))
    :1 ,(make-letter '(((2/5 5/10) (0 5/10))
                       ((0 5/10) (1 5/10))))
    :2 ,(make-letter '(((1/5 1/10) (0 3/10))
                       ((0 3/10) (0 7/10))
                       ((0 7/10) (1/5 9/10))
                       ((1/5 9/10) (4/5 1/10))
                       ((4/5 1/10) (1 3/10))
                       ((1 3/10) (1 7/10))
                       ((1 7/10) (4/5 9/10))))
    :3 ,(make-letter '(((0 1/5) (0 7/10))
                       ((0 7/10) (1/5 9/10))
                       ((1/5 9/10) (4/5 9/10))
                       ((4/5 9/10) (1 7/10))
                       ((1 7/10) (1 1/5))
                       ((5/10 9/10) (5/10 2/5))))
    :4 ,(make-letter '(((0 1/10) (7/10 1/10))
                       ((7/10 1/10) (7/10 7/10))
                       ((2/5 2/5) (1 2/5))))
    :5 ,(make-letter '(((1/10 9/10) (1/10 3/10))
                       ((1/10 3/10) (2/5 3/10))
                       ((2/5 3/10) (2/5 7/10))
                       ((2/5 7/10) (3/5 9/10))
                       ((3/5 9/10) (4/5 9/10))
                       ((4/5 9/10) (1 7/10))
                       ((1 7/10) (1 3/10))))
    :6 ,(make-letter '(((0 9/10) (0 5/10))
                       ((0 5/10) (1/5 3/10))
                       ((1/5 3/10) (4/5 3/10))
                       ((4/5 3/10) (1 5/10))
                       ((1 5/10) (1 7/10))
                       ((1 7/10) (4/5 9/10))
                       ((4/5 9/10) (3/5 9/10))
                       ((3/5 9/10) (2/5 7/10))
                       ((2/5 7/10) (2/5 3/10))))
    :7 ,(make-letter '((())))
    :8 ,(make-letter '((())))
    :9 ,(make-letter '((())))))

;; DRAW THINGS
(defun draw-segment (seg)
  (destructuring-bind ((ya xa) (yb xb)) seg
    (let ((shape (croatoan:line ya xa yb xb)))
      (setf (croatoan:color-pair *win*) '(:white :white))
      (croatoan:draw-shape *win* (croatoan:fill-shape shape)))))

(defun draw-letter (letter)
  (loop for segment in letter
        do (draw-segment segment)))

;; RECTANGLE

(defun make-rect (y x w h)
  (list (list y x) w h))

(defun yrect (r)
  (caar r))
(defun xrect (r)
  (cadar r))
(defun origrect (r)
  (car r))
(defun wrect (r)
  (cadr r))
(defun hrect (r)
  (caddr r))

;; DISPLAY TITLE

(defun draw-title (string rect)
  (let ((rect-length (/ (wrect rect) (length string))))
    (loop for letter in (str->kw string)
          for i below (length string)
          do (funcall (getf letters letter)
                      (make-rect (yrect rect)
                                 (* rect-length i)
                                 rect-length
                                 (hrect rect))))))

;; MAIN
(defvar *scr* nil)
(defun bind-handlers (scr)
  (croatoan:bind scr #\q
                 (lambda (w e) (throw 'event-loop :quit)))

  (croatoan:bind scr #\c
                (lambda (w e)
                  (croatoan:clear w)))

  (croatoan:bind scr t
                 (lambda (w e)
                   (let ((*win* w)
                         (ww (croatoan:width w))
                         (hh (croatoan:height w)))
                     (croatoan:clear w)
                     (draw-title "Spacomic"
                                 (make-rect
                                  (round (* .3 hh))
                                  (round (* .1 ww))
                                  (round (* 1 ww))
                                  (round (* .1 hh))))))))

(defun MAIN ()
  (let ((*debugger-hook* nil))
   (croatoan:with-screen (scr :input-blocking 100)
     (bind-handlers scr)
     (croatoan:run-event-loop (setf *scr* scr))))
  (sb-ext:exit))

